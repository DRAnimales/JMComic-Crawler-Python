name: å¯¼å‡ºæ”¶è—å¤¹æ•°æ®

on:
  schedule:
    - cron: "0 0 * * 3"
  workflow_dispatch:
    inputs:
      IN_JM_USERNAME:
        type: string
        default: ''
        description: 'ç¦æ¼«å¸å·ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œä¼šæ³„éœ²åœ¨æ—¥å¿—ä¸­ã€‚æœ€å¥½ç”¨secretsï¼‰'
        required: false

      IN_JM_PASSWORD:
        type: string
        default: ''
        description: 'ç¦æ¼«å¯†ç ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œä¼šæ³„éœ²åœ¨æ—¥å¿—ä¸­ã€‚æœ€å¥½ç”¨secretsï¼‰'
        required: false

      IN_ZIP_PASSWORD:
        type: string
        default: ''
        description: 'å‹ç¼©æ–‡ä»¶å¯†ç ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œä¼šæ³„éœ²åœ¨æ—¥å¿—ä¸­ã€‚æœ€å¥½ç”¨secretsï¼‰'
        required: false

jobs:
  crawler:
    runs-on: ubuntu-latest
    env:
      # å·¥ä½œæµè¾“å…¥
      IN_JM_USERNAME: ${{ github.event.inputs.IN_JM_USERNAME }}
      IN_JM_PASSWORD: ${{ github.event.inputs.IN_JM_PASSWORD }}
      IN_ZIP_PASSWORD: ${{ github.event.inputs.IN_ZIP_PASSWORD }}

      # ç™»å½•ç›¸å…³secrets
      JM_USERNAME: ${{ secrets.JM_USERNAME }}
      JM_PASSWORD: ${{ secrets.JM_PASSWORD }}
      ZIP_PASSWORD: ${{ secrets.ZIP_PASSWORD }}

      # é‚®ä»¶ç›¸å…³secrets
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TITLE: ${{ secrets.EMAIL_TITLE }}
      EMAIL_CONTENT: ${{ secrets.EMAIL_CONTENT }}

      # å›ºå®šå€¼
      ZIP_FP: /home/runner/work/jmcomic/download/export.7z

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependency
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          sudo apt update
          sudo apt install p7zip-full

      - name: å®‰è£…jmcomicï¼ˆlocalï¼‰
        run: |
          pip install -e ./

      - name: æ‰§è¡Œä»£ç 
        run: |
          cd ./usage/
          python workflow_export_favorites.py

      - name: ğŸš€ è§£å‹å¹¶å°†æ¸…å•æ¨é€è‡³ä»“åº“æ ¹ç›®å½•
        run: |
          cd ./usage/
          # 1. ä½¿ç”¨ä½ å·²ç»åœ¨ env ä¸­é…ç½®å¥½çš„ ZIP_PASSWORD è§£å‹
          7z x export.7z -p${{ env.ZIP_PASSWORD }} -y
          
          # 2. å°†è§£å‹å‡ºçš„ csv ç§»åŠ¨å¹¶é‡å‘½ååˆ°ä»“åº“æ ¹ç›®å½•
          mv *.csv ../favorite_list.csv || true
          
          cd ..
          # 3. æäº¤å¹¶æ¨é€è‡³ master åˆ†æ”¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add favorite_list.csv
          
          # åªæœ‰åœ¨æ¸…å•æœ‰å˜åŒ–æ—¶æ‰æäº¤ï¼Œé˜²æ­¢ workflow æŠ¥é”™
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ¤– è‡ªåŠ¨åŒæ­¥æœ€æ–°æ”¶è—æ¸…å•" && git push)

      - name: ä¸Šä¼ ç»“æœ (ä¿ç•™åŸå§‹ Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: 'å¯¼å‡ºçš„æ”¶è—å¤¹'
          path: ${{ env.ZIP_FP }}
          retention-days: 7
